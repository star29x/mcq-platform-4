<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Flow</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #2d3748;
        }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white; padding: 6px 16px; border-radius: 20px;
            font-size: 0.4em; font-weight: 600; margin-left: 10px; vertical-align: middle;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .api-section {
            background: #fff3cd; border: 2px solid #ffc107;
            border-left: 4px solid #ff9800; padding: 20px; border-radius: 8px; margin-bottom: 30px;
        }
        .api-section h3 { color: #856404; margin-bottom: 15px; }
        .api-section input { width: 100%; padding: 12px; border: 2px solid #ffc107; border-radius: 6px; font-size: 1em; margin-top: 10px; }
        .api-section a { color: #0066cc; font-weight: 600; }
        .input-section { background: #f7fafc; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        input[type="text"], input[type="file"] { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; }
        input[type="file"] { border-style: dashed; cursor: pointer; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 30px; border-radius: 8px;
            font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.6); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-ai { background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); }
        .btn-download { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .loading { display: none; text-align: center; padding: 30px; background: #e3f2fd; border-radius: 12px; margin: 20px 0; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4285f4; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mcq { background: white; border: 2px solid #e2e8f0; padding: 25px; margin-bottom: 25px; border-radius: 12px; }
        .mcq-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; margin: -25px -25px 20px -25px; border-radius: 10px 10px 0 0; font-size: 1.2em; font-weight: 600; }
        .question-text { background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea; line-height: 1.6; }
        .stem { padding: 15px; margin-bottom: 12px; background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; }
        .stem-header { font-weight: 600; color: #667eea; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .stem-letter { background: #667eea; color: white; width: 28px; height: 28px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
        .stem-text { color: #4a5568; margin-bottom: 12px; line-height: 1.5; padding-left: 36px; }
        .stem-options { display: flex; gap: 20px; align-items: center; padding-left: 36px; }
        .stem-options label { display: inline-flex; align-items: center; margin: 0; cursor: pointer; font-weight: normal; }
        input[type="radio"] { margin-right: 6px; cursor: pointer; width: 18px; height: 18px; }
        .deselect-btn { background: #fc8181; padding: 6px 16px; font-size: 0.85em; }
        .results { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 25px; border-radius: 12px; margin-top: 30px; font-size: 1.3em; text-align: center; font-weight: 600; display: none; }
        .results.show { display: block; }
        .feedback { margin-top: 30px; display: none; }
        .feedback.show { display: block; }
        /* Feedback cards */
        .feedback-mcq { background: white; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 28px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .feedback-mcq-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 20px; font-size: 1.05em; font-weight: 700; }
        .feedback-mcq-body { padding: 20px; }
        .feedback-question { background: #f0f4ff; padding: 14px 18px; border-radius: 8px; margin-bottom: 18px; border-left: 4px solid #667eea; font-size: 1em; font-weight: 500; line-height: 1.6; color: #2d3748; }
        .feedback-stem { padding: 14px 16px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #ccc; }
        .feedback-stem.correct   { background: #f0fff4; border-left-color: #48bb78; }
        .feedback-stem.incorrect { background: #fff5f5; border-left-color: #fc8181; }
        .feedback-stem.unattempted { background: #fffaf0; border-left-color: #ed8936; }
        .feedback-stem-row { display: flex; align-items: flex-start; gap: 12px; }
        .fb-letter { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9em; flex-shrink: 0; color: white; margin-top: 2px; }
        .correct   .fb-letter { background: #38a169; }
        .incorrect .fb-letter { background: #e53e3e; }
        .unattempted .fb-letter { background: #dd6b20; }
        .fb-content { flex: 1; }
        .fb-stem-text { font-weight: 500; line-height: 1.5; color: #2d3748; margin-bottom: 6px; }
        .fb-status { font-size: 0.85em; font-weight: 700; margin-bottom: 5px; }
        .correct   .fb-status { color: #276749; }
        .incorrect .fb-status { color: #9b2c2c; }
        .unattempted .fb-status { color: #7b341e; }
        .answer-tag { display: inline-block; padding: 2px 10px; border-radius: 10px; font-size: 0.82em; font-weight: 700; margin: 0 3px; }
        .tag-true  { background: #c6f6d5; color: #22543d; }
        .tag-false { background: #fed7d7; color: #742a2a; }
        .fb-explanation { background: rgba(255,255,255,0.75); border-radius: 6px; padding: 9px 12px; font-size: 0.9em; font-style: italic; line-height: 1.5; color: #4a5568; margin-top: 6px; border-left: 3px solid #a0aec0; }
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .message.success { background: #f0fff4; border-left: 4px solid #48bb78; color: #22543d; display: block; }
        .message.error   { background: #fff5f5; border-left: 4px solid #f56565; color: #742a2a; display: block; }
        .download-section { text-align: center; margin-top: 24px; display: none; }
    </style>
</head>
<body>
<div class="header">
    <h1>ü§ñ Gemini-Powered MCQ Platform <span class="badge">GEMINI AI</span></h1>
    <p>Auto-generate answers &amp; explanations with Google Gemini</p>
</div>

<div class="container">
    <div class="api-section">
        <h3>üîë Setup: Enter Your Free Gemini API Key</h3>
        <p style="margin-bottom:10px;color:#856404;">Get your free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
        <input type="password" id="apiKey" placeholder="Paste your Gemini API key here..." onchange="saveApiKey()">
        <small style="color:#856404;display:block;margin-top:8px;">‚úÖ Your key is stored locally ‚Ä¢ Free tier: 15 requests/min ‚Ä¢ 1M tokens/day</small>
    </div>

    <div class="input-section">
        <div class="input-group">
            <label for="topicName">üìñ Topic Name</label>
            <input type="text" id="topicName" placeholder="e.g., Intra Uterine Growth Retardation">
        </div>
        <div class="input-group">
            <label for="questionsFile">üìÑ Upload Questions CSV</label>
            <input type="file" id="questionsFile" accept=".csv" onchange="handleQuestionsUpload(event)">
        </div>
        <button onclick="loadMCQs()" style="width:100%;margin-bottom:15px;">üìö Load MCQs</button>
        <button class="btn-ai" onclick="generateAnswersWithGemini()" id="aiAnswerBtn" style="width:100%;display:none;">
            ‚ú® Generate Answers &amp; Explanations with Gemini AI
        </button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <strong>Gemini AI is analyzing your MCQs...</strong>
        <p>Generating answers and explanations. This may take 30‚Äì60 seconds.</p>
    </div>

    <div id="message"></div>
    <div id="mcqs"></div>

    <div class="input-section" id="submitSection" style="display:none;">
        <div style="text-align:center;">
            <button onclick="evaluateAnswers()" style="font-size:1.1em;padding:15px 40px;">üìù Submit &amp; See Results</button>
        </div>
    </div>

    <div class="results" id="results"></div>
    <div class="feedback" id="feedback"></div>

    <div class="download-section" id="downloadSection">
        <button class="btn-download" onclick="downloadDocx()">üìÑ Download Results as Word Document</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
    let questionsData   = [];
    let aiAnswers       = [];
    let aiExplanations  = [];
    let lastEvalResults = null;
    const stemLetters   = ['A','B','C','D','E'];

    window.onload = function() {
        const saved = localStorage.getItem('gemini_api_key');
        if (saved) document.getElementById('apiKey').value = saved;
    };

    function saveApiKey() {
        const k = document.getElementById('apiKey').value.trim();
        if (k) { localStorage.setItem('gemini_api_key', k); showMessage('‚úÖ API key saved!','success'); }
    }

    function handleQuestionsUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => parseQuestionsCSV(ev.target.result);
        reader.readAsText(file);
    }

    function parseQuestionsCSV(content) {
        const lines = content.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
        if (!lines.length) { showMessage('‚ùå CSV file is empty!','error'); return; }
        const dataLines = lines.slice(1);
        questionsData = [];
        let currentMCQ = null;
        dataLines.forEach(line => {
            const matches = line.match(/("([^"]*)"|[^,]+)/g);
            if (!matches || matches.length < 3) return;
            const mcqNum  = parseInt(matches[0].replace(/"/g,''));
            const stemNum = parseInt(matches[1].replace(/"/g,''));
            const text    = matches[2].replace(/^"|"$/g,'').replace(/""/g,'"');
            if (stemNum === 0) {
                currentMCQ = { number: mcqNum, question: text, stems: [] };
                questionsData.push(currentMCQ);
            } else {
                if (currentMCQ && currentMCQ.number === mcqNum)
                    currentMCQ.stems.push({ number: stemNum, letter: stemLetters[stemNum-1], text });
            }
        });
        showMessage(`‚úÖ Successfully loaded ${questionsData.length} MCQ(s)!`,'success');
    }

    function loadMCQs() {
        if (!document.getElementById('topicName').value.trim()) { showMessage('‚ùå Please enter a topic name.','error'); return; }
        if (!questionsData.length) { showMessage('‚ùå Please upload the questions CSV file first.','error'); return; }
        displayMCQs();
        document.getElementById('aiAnswerBtn').style.display = 'block';
        showMessage('‚úÖ MCQs loaded! Click "Generate Answers with Gemini AI" to get answers and explanations.','success');
    }

    function displayMCQs() {
        const mcqsDiv = document.getElementById('mcqs');
        mcqsDiv.innerHTML = '';
        questionsData.forEach(mcq => {
            const div = document.createElement('div');
            div.className = 'mcq';
            let html = `<div class="mcq-header">MCQ ${mcq.number}</div>
                        <div class="question-text"><strong>Question:</strong> ${mcq.question}</div>`;
            mcq.stems.forEach(stem => {
                html += `<div class="stem">
                    <div class="stem-header">
                        <span class="stem-letter">${stem.letter}</span>
                        <span>Option ${stem.letter}</span>
                    </div>
                    <div class="stem-text">${stem.text}</div>
                    <div class="stem-options">
                        <label><input type="radio" name="mcq${mcq.number}stem${stem.number}" value="T"> True</label>
                        <label><input type="radio" name="mcq${mcq.number}stem${stem.number}" value="F"> False</label>
                        <button class="deselect-btn" onclick="deselectAnswer('mcq${mcq.number}stem${stem.number}')">Clear</button>
                    </div>
                </div>`;
            });
            div.innerHTML = html;
            mcqsDiv.appendChild(div);
        });
        document.getElementById('submitSection').style.display = 'block';
    }

    async function generateAnswersWithGemini() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey)               { showMessage('‚ùå Please enter your Gemini API key first!','error'); return; }
        if (!questionsData.length) { showMessage('‚ùå Please load MCQs first!','error'); return; }

        const loading = document.getElementById('loading');
        const aiBtn   = document.getElementById('aiAnswerBtn');
        loading.classList.add('active');
        aiBtn.disabled = true;

        try {
            let mcqText = '';
            questionsData.forEach(mcq => {
                mcqText += `MCQ ${mcq.number}:\nQuestion: ${mcq.question}\n`;
                mcq.stems.forEach(s => { mcqText += `${s.letter}. ${s.text}\n`; });
                mcqText += '\n';
            });

            const prompt = `You are a medical education expert. For each MCQ below, analyze each option (A, B, C, D, E) and determine if it is TRUE or FALSE. Then provide a brief explanation (1-2 sentences) for each option.

Format your response EXACTLY like this for each MCQ:

MCQ 1:
A: T - [Brief explanation]
B: F - [Brief explanation]
C: T - [Brief explanation]
D: F - [Brief explanation]
E: T - [Brief explanation]

MCQ 2:
A: F - [Brief explanation]
...and so on

MCQs to analyze:
${mcqText}

Provide ONLY the answers and explanations in the format above.`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                { method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }] }) }
            );
            const data = await response.json();
            if (data.candidates?.[0]?.content?.parts?.[0]) {
                parseGeminiResponse(data.candidates[0].content.parts[0].text);
                showMessage('‚úÖ Gemini AI has generated answers and explanations! You can now attempt the MCQs.','success');
            } else if (data.error) {
                throw new Error(data.error.message || 'API error');
            } else {
                throw new Error('Invalid response from Gemini AI');
            }
        } catch(err) {
            console.error(err);
            showMessage('‚ùå Gemini AI generation failed. Please check your API key and internet connection.','error');
        } finally {
            loading.classList.remove('active');
            aiBtn.disabled = false;
        }
    }

    function parseGeminiResponse(responseText) {
        aiAnswers = []; aiExplanations = [];
        const mcqBlocks = responseText.split(/MCQ \d+:/);
        questionsData.forEach((mcq, idx) => {
            const ans = [], expl = [];
            if (idx + 1 < mcqBlocks.length) {
                const block = mcqBlocks[idx + 1];
                const lines = block.split('\n').filter(l => l.trim());
                ['A','B','C','D','E'].forEach(letter => {
                    const line = lines.find(l => l.trim().startsWith(letter + ':'));
                    if (line) {
                        const match = line.match(/[A-E]:\s*([TF])\s*-\s*(.+)/i);
                        if (match) { ans.push(match[1].toUpperCase()); expl.push(match[2].trim()); }
                        else       { ans.push('F'); expl.push('No explanation provided'); }
                    } else { ans.push('F'); expl.push(''); }
                });
            } else { ans.push('F','F','F','F','F'); expl.push('','','','',''); }
            aiAnswers.push(ans); aiExplanations.push(expl);
        });
    }

    function deselectAnswer(stemName) {
        document.getElementsByName(stemName).forEach(r => r.checked = false);
    }

    /* ‚îÄ‚îÄ Evaluate & build rich feedback ‚îÄ‚îÄ */
    function evaluateAnswers() {
        if (!aiAnswers.length) { showMessage('‚ùå Please generate answers with Gemini AI first!','error'); return; }

        const topicName = document.getElementById('topicName').value.trim();
        let totalScore  = 0;
        const totalMax  = questionsData.length * 5;
        lastEvalResults = [];

        const feedbackDiv = document.getElementById('feedback');
        feedbackDiv.innerHTML = '';

        questionsData.forEach((mcq, mcqIdx) => {
            let mcqScore = 0;
            const stemResults = [];

            mcq.stems.forEach((stem, sIdx) => {
                const correct = aiAnswers[mcqIdx][sIdx];
                const expl    = aiExplanations[mcqIdx][sIdx];
                const radios  = document.getElementsByName(`mcq${mcq.number}stem${stem.number}`);
                let selected  = null;
                radios.forEach(r => { if (r.checked) selected = r.value.toUpperCase(); });

                let status;
                if (!selected)                 { status = 'unattempted'; }
                else if (selected === correct) { status = 'correct';   mcqScore++; }
                else                           { status = 'incorrect'; mcqScore--; }

                stemResults.push({ stem, correct, selected, expl, status });
            });

            if (mcqScore < 0) mcqScore = 0;
            totalScore += mcqScore;
            lastEvalResults.push({ mcq, mcqScore, stemResults });

            /* Build feedback card */
            const correctCount     = stemResults.filter(r=>r.status==='correct').length;
            const incorrectCount   = stemResults.filter(r=>r.status==='incorrect').length;
            const unattemptedCount = stemResults.filter(r=>r.status==='unattempted').length;

            const card = document.createElement('div');
            card.className = 'feedback-mcq';
            card.innerHTML = `
                <div class="feedback-mcq-header">
                    MCQ ${mcq.number} &nbsp;¬∑&nbsp; Score: ${mcqScore}/${mcq.stems.length}
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    ‚úÖ ${correctCount} &nbsp; ‚ùå ${incorrectCount} &nbsp; ‚è≠ ${unattemptedCount}
                </div>
                <div class="feedback-mcq-body">
                    <div class="feedback-question"><strong>Q:</strong> ${mcq.question}</div>
                    ${stemResults.map(r => {
                        const correctTag = `<span class="answer-tag ${r.correct==='T'?'tag-true':'tag-false'}">${r.correct==='T'?'TRUE':'FALSE'}</span>`;
                        let statusHtml;
                        if (r.status === 'correct') {
                            statusHtml = `‚úÖ Correct &nbsp;¬∑&nbsp; Answer: ${correctTag}`;
                        } else if (r.status === 'incorrect') {
                            const yourTag = `<span class="answer-tag ${r.selected==='T'?'tag-true':'tag-false'}">${r.selected==='T'?'TRUE':'FALSE'}</span>`;
                            statusHtml = `‚ùå Incorrect &nbsp;¬∑&nbsp; You answered: ${yourTag} &nbsp;¬∑&nbsp; Correct: ${correctTag}`;
                        } else {
                            statusHtml = `‚è≠ Not attempted &nbsp;¬∑&nbsp; Correct answer: ${correctTag}`;
                        }
                        return `
                        <div class="feedback-stem ${r.status}">
                            <div class="feedback-stem-row">
                                <div class="fb-letter">${r.stem.letter}</div>
                                <div class="fb-content">
                                    <div class="fb-stem-text">${r.stem.text}</div>
                                    <div class="fb-status">${statusHtml}</div>
                                    ${r.expl ? `<div class="fb-explanation">üí° ${r.expl}</div>` : ''}
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
            feedbackDiv.appendChild(card);
        });

        const pct = ((totalScore / totalMax) * 100).toFixed(1);
        const resultDiv = document.getElementById('results');
        resultDiv.innerHTML = `<strong>${topicName}</strong><br>Score: ${totalScore} / ${totalMax} &nbsp;(${pct}%)`;
        resultDiv.classList.add('show');
        feedbackDiv.classList.add('show');
        document.getElementById('downloadSection').style.display = 'block';
        resultDiv.scrollIntoView({ behavior:'smooth', block:'center' });
    }

    /* ‚îÄ‚îÄ Download as Word (.docx) ‚îÄ‚îÄ */
    function xmlEsc(str) {
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&apos;');
    }

    function para(text, opts={}) {
        const { bold=false, styleId='Normal', color='', indent=0 } = opts;
        const rPr = [
            bold ? '<w:b/>' : '',
            color ? `<w:color w:val="${color}"/>` : ''
        ].join('');
        const pPr = [
            `<w:pStyle w:val="${styleId}"/>`,
            indent ? `<w:ind w:left="${indent}"/>` : '',
            '<w:spacing w:after="80"/>'
        ].join('');
        return `<w:p>
            <w:pPr>${pPr}</w:pPr>
            <w:r>${rPr ? `<w:rPr>${rPr}</w:rPr>` : ''}<w:t xml:space="preserve">${xmlEsc(text)}</w:t></w:r>
        </w:p>`;
    }

    function downloadDocx() {
        if (!lastEvalResults) { alert('Please submit answers first.'); return; }
        const topicName = document.getElementById('topicName').value.trim() || 'MCQ Results';
        const totalMax  = questionsData.length * 5;
        const totalScore = lastEvalResults.reduce((s,r)=>s+r.mcqScore,0);
        const pct = ((totalScore/totalMax)*100).toFixed(1);

        let bodyXml = '';

        /* Title block */
        bodyXml += para(topicName, { bold:true, styleId:'Heading1' });
        bodyXml += para(`Date: ${new Date().toLocaleDateString()}`, { bold:false });
        bodyXml += para(`Overall Score: ${totalScore} / ${totalMax}  (${pct}%)`, { bold:true, color:'2E7D32' });
        bodyXml += para('');

        lastEvalResults.forEach(({ mcq, mcqScore, stemResults }) => {
            /* MCQ heading */
            bodyXml += para(`MCQ ${mcq.number}   ‚Äî   Score: ${mcqScore} / ${mcq.stems.length}`, { styleId:'Heading2' });
            /* Question */
            bodyXml += para(`Question: ${mcq.question}`, { bold:true });
            bodyXml += para('');

            stemResults.forEach(r => {
                const correctLabel = r.correct === 'T' ? 'TRUE' : 'FALSE';
                let yourAnswer = 'Not attempted';
                if (r.selected) yourAnswer = r.selected === 'T' ? 'TRUE' : 'FALSE';
                let resultMark = r.status === 'correct' ? '‚úì CORRECT' : r.status === 'incorrect' ? '‚úó INCORRECT' : '‚Äî SKIPPED';
                /* Stem text */
                bodyXml += para(`${r.stem.letter}.  ${r.stem.text}`, { indent: 360 });
                /* Result line */
                bodyXml += para(`${resultMark}   |   Your answer: ${yourAnswer}   |   Correct: ${correctLabel}`, { indent: 720, bold: r.status==='incorrect' });
                /* Explanation */
                if (r.expl) {
                    bodyXml += para(`Explanation: ${r.expl}`, { indent: 720, color:'4A5568' });
                }
                bodyXml += para('');
            });
        });

        const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
            xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${bodyXml}
    <w:sectPr>
      <w:pgSz w:w="12240" w:h="15840"/>
      <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/>
    </w:sectPr>
  </w:body>
</w:document>`;

        const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:style w:type="paragraph" w:styleId="Normal" w:default="1">
    <w:name w:val="Normal"/>
    <w:rPr><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading1">
    <w:name w:val="heading 1"/>
    <w:basedOn w:val="Normal"/>
    <w:pPr><w:spacing w:before="240" w:after="120"/></w:pPr>
    <w:rPr><w:b/><w:sz w:val="36"/><w:color w:val="4F46E5"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading2">
    <w:name w:val="heading 2"/>
    <w:basedOn w:val="Normal"/>
    <w:pPr><w:spacing w:before="200" w:after="80"/>
      <w:pBdr><w:bottom w:val="single" w:sz="4" w:space="1" w:color="C4B5FD"/></w:pBdr>
    </w:pPr>
    <w:rPr><w:b/><w:sz w:val="28"/><w:color w:val="5B21B6"/></w:rPr>
  </w:style>
</w:styles>`;

        const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

        const dotRelsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

        const contentTypesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml"  ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml"   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

        if (typeof JSZip === 'undefined') {
            showMessage('‚ùå JSZip library not loaded. Please check your internet connection.','error');
            return;
        }

        const zip = new JSZip();
        zip.file('[Content_Types].xml', contentTypesXml);
        zip.file('_rels/.rels', dotRelsXml);
        zip.file('word/document.xml', docXml);
        zip.file('word/styles.xml', stylesXml);
        zip.file('word/_rels/document.xml.rels', relsXml);

        zip.generateAsync({ type:'blob', mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
            .then(blob => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${topicName.replace(/\s+/g,'_')}_Results.docx`;
                a.click();
                URL.revokeObjectURL(a.href);
            })
            .catch(err => {
                console.error(err);
                showMessage('‚ùå Failed to generate Word document.','error');
            });
    }

    function showMessage(text, type) {
        const m = document.getElementById('message');
        m.className = 'message ' + type;
        m.innerHTML = text;
    }
</script>
</body>
</html>
